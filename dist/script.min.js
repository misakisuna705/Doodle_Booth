const MAX=60;let canvas_x,canvas_y,canvas_data=[],canvas_count=-1;function doodle_box_set(){const a=document.getElementById("doodle_box"),t=a.width/a.clientWidth;let c,n,e=event.target.getBoundingClientRect();switch(event.type){case"touchstart":case"touchmove":event.offsetX=event.targetTouches[0].pageX-e.left,event.offsetY=event.targetTouches[0].pageY-e.top}return{x:c=event.offsetX*t,y:n=event.offsetY*t}}function set_canvas_data(){const a=canvas.getContext("2d").getImageData(0,0,canvas.width,canvas.height);if(canvas_count==MAX){for(let a=0;a<MAX;a++)canvas_canvas_data[a]=canvas_data[a+1];canvas_data[MAX]=a}else canvas_data[++canvas_count]=a}function draw_image(a,t){switch(tool_action){case"pencil":case"eraser":draw_path();break;case"hollow_circle":draw_hollow_circle();break;case"hollow_triangle":draw_hollow_triangle();break;case"hollow_rectangle":draw_hollow_rectangle();break;case"solid_circle":draw_solid_circle();break;case"solid_triangle":draw_solid_triangle();break;case"solid_rectangle":draw_solid_rectangle()}}function draw_path(){canvas_context.clearRect(0,0,canvas.width,canvas.height),canvas_context.putImageData(canvas_data[canvas_count],0,0),canvas_context.lineTo(set_canvas().x,set_canvas().y),canvas_context.stroke()}function draw_hollow_circle(){let a=((set_canvas().x-canvas_x)**2+(set_canvas().y-canvas_y)**2)**.5;canvas_context.clearRect(0,0,canvas.width,canvas.height),canvas_context.putImageData(canvas_data[canvas_count],0,0),canvas_context.beginPath(),canvas_context.arc(canvas_x,canvas_y,a,0*Math.PI/180,360*Math.PI/180),canvas_context.stroke()}function draw_hollow_triangle(){let a=canvas_y-set_canvas().y;canvas_context.clearRect(0,0,canvas.width,canvas.height),canvas_context.putImageData(canvas_data[canvas_count],0,0),canvas_context.beginPath(),canvas_context.moveTo(canvas_x,canvas_y),canvas_context.lineTo(set_canvas().x,canvas_y+a),canvas_context.lineTo(set_canvas().x,set_canvas().y),canvas_context.closePath(),canvas_context.stroke()}function draw_hollow_rectangle(){canvas_context.clearRect(0,0,canvas.width,canvas.height),canvas_context.putImageData(canvas_data[canvas_count],0,0),canvas_context.beginPath(),canvas_context.moveTo(canvas_x,canvas_y),canvas_context.strokeRect(canvas_x,canvas_y,set_canvas().x-canvas_x,set_canvas().y-canvas_y)}function draw_solid_circle(){let a=((set_canvas().x-canvas_x)**2+(set_canvas().y-canvas_y)**2)**.5;canvas_context.clearRect(0,0,canvas.width,canvas.height),canvas_context.putImageData(canvas_data[canvas_count],0,0),canvas_context.beginPath(),canvas_context.arc(canvas_x,canvas_y,a,0*Math.PI/180,360*Math.PI/180),canvas_context.fill()}function draw_solid_triangle(){let a=canvas_y-set_canvas().y;canvas_context.clearRect(0,0,canvas.width,canvas.height),canvas_context.putImageData(canvas_data[canvas_count],0,0),canvas_context.beginPath(),canvas_context.moveTo(canvas_x,canvas_y),canvas_context.lineTo(set_canvas().x,canvas_y+a),canvas_context.lineTo(set_canvas().x,set_canvas().y),canvas_context.fill()}function draw_solid_rectangle(){canvas_context.clearRect(0,0,canvas.width,canvas.height),canvas_context.putImageData(canvas_data[canvas_count],0,0),canvas_context.beginPath(),canvas_context.moveTo(canvas_x,canvas_y),canvas_context.fillRect(canvas_x,canvas_y,set_canvas().x-canvas_x,set_canvas().y-canvas_y)}
let color_picker,color_block,color_block_context,color_strip,color_strip_context,color_label,color_rgb,color_data,color_x,color_y,grd1;function changeColor(o){switch(color_x=o.offsetX,color_y=o.offsetY,o.target.id){case"color_block":color_rgb=color_block_context.getImageData(color_x,color_y,1,1).data;break;case"color_strip":color_rgb=color_strip_context.getImageData(color_x,color_y,1,1).data}color_data="rgba("+color_rgb[0]+","+color_rgb[1]+","+color_rgb[2]+",1)",color_label.style.backgroundColor=color_data}function fillGradient(){color_block_context.fillStyle=color_data,color_block_context.fillRect(0,0,color_block.width,color_block.height);var o=color_strip_context.createLinearGradient(0,0,color_block.width,0);o.addColorStop(0,"rgba(255,255,255,1)"),o.addColorStop(1,"rgba(255,255,255,0)"),color_block_context.fillStyle=o,color_block_context.fillRect(0,0,color_block.width,color_block.height);var l=color_strip_context.createLinearGradient(0,0,0,color_block.height);l.addColorStop(0,"rgba(0,0,0,0)"),l.addColorStop(1,"rgba(0,0,0,1)"),color_block_context.fillStyle=l,color_block_context.fillRect(0,0,color_block.width,color_block.height)}
function init(){tool_init(),color_init();const o=document.getElementById("doodle_box");toolspace.addEventListener("click",select_tool,!1),o.addEventListener("touchstart",e=>{set_canvas_data(),set_tool(e),e.preventDefault(),o.addEventListener("touchmove",()=>{draw_image(e),e.preventDefault()},!1)},!1),o.addEventListener("touchend",e=>{e.preventDefault(),o.removeEventListener("touchmove",()=>{draw_image(e),e.preventDefault()},!1)},!1),o.addEventListener("mousedown",()=>{set_canvas_data(),set_tool(event),o.addEventListener("mousemove",draw_image,!1)},!1),o.addEventListener("mouseup",()=>{o.removeEventListener("mousemove",draw_image,!1)},!1),color_picker.addEventListener("click",()=>{changeColor(event),"color_strip"==event.target.id&&fillGradient()},!1),color_block.addEventListener("mousedown",()=>{color_block.addEventListener("mousemove",changeColor,!1)},!1),color_block.addEventListener("mouseup",()=>{color_block.removeEventListener("mousemove",changeColor,!1)},!1)}function tool_init(){toolspace=document.getElementById("toolspace")}function color_init(){color_picker=document.getElementById("color_picker"),color_block=document.getElementById("color_block"),color_strip=document.getElementById("color_strip"),color_label=document.getElementById("color_label"),color_block_context=color_block.getContext("2d"),color_strip_context=color_strip.getContext("2d"),color_x=0,color_y=0,color_data="rgba(255,0,0,1)",color_label.style.backgroundColor=color_data,color_block_context.rect(0,0,color_block.width,color_block.height),fillGradient(),color_strip_context.rect(0,0,color_strip.width,color_strip.height),grd1=color_strip_context.createLinearGradient(0,0,0,color_block.height),grd1.addColorStop(0,"rgba(255, 0, 0, 1)"),grd1.addColorStop(.17,"rgba(255, 255, 0, 1)"),grd1.addColorStop(.34,"rgba(0, 255, 0, 1)"),grd1.addColorStop(.51,"rgba(0, 255, 255, 1)"),grd1.addColorStop(.68,"rgba(0, 0, 255, 1)"),grd1.addColorStop(.85,"rgba(255, 0, 255, 1)"),grd1.addColorStop(1,"rgba(255, 0, 0, 1)"),color_strip_context.fillStyle=grd1,color_strip_context.fill()}window.addEventListener("DOMContentLoaded",init,!1);
let tool_action,toolspace;function select_tool(a){switch(a.target.id){case"cursor":canvas.style.cursor="default",tool_action=a.target.id;break;case"pencil":canvas.style.cursor="url('res/image/pencil.png'), auto",tool_action=a.target.id;break;case"eraser":canvas.style.cursor="url('res/image/eraser.png'), auto",tool_action=a.target.id;break;case"hollow_circle":canvas.style.cursor="url('res/image/hollow_circle.png'), auto",tool_action=a.target.id;break;case"hollow_triangle":canvas.style.cursor="url('res/image/hollow_triangle.png'), auto",tool_action=a.target.id;break;case"hollow_rectangle":canvas.style.cursor="url('res/image/hollow_rectangle.png'), auto",tool_action=a.target.id;break;case"solid_circle":canvas.style.cursor="url('res/image/solid_circle.png'), auto",tool_action=a.target.id;break;case"solid_triangle":canvas.style.cursor="url('res/image/solid_triangle.png'), auto",tool_action=a.target.id;break;case"solid_rectangle":canvas.style.cursor="url('res/image/solid_rectangle.png'), auto",tool_action=a.target.id;break;case"undo":canvas_count>=0&&(canvas_context.clearRect(0,0,canvas.width,canvas.height),canvas_context.putImageData(canvas_data[canvas_count],0,0),canvas_count--);break;case"redo":canvas_count<canvas_data.length-1&&(canvas_count++,canvas_context.clearRect(0,0,canvas.width,canvas.height),canvas_context.putImageData(canvas_data[canvas_count],0,0));break;case"reset":canvas_context.clearRect(0,0,canvas.width,canvas.height);break;case"download":document.getElementById("link").setAttribute("href",canvas.toDataURL("image/png"));break;case"upload":if(canvas_count==MAX){for(let a=0;a<MAX;a++)canvas_data[a]=canvas_data[a+1];canvas_data[MAX]=canvas_context.getImageData(0,0,canvas.width,canvas.height)}else canvas_count++,canvas_data[canvas_count]=canvas_context.getImageData(0,0,canvas.width,canvas.height);let e=document.getElementById("image");canvas_context.drawImage(e,doodle_box_set().x,doodle_box_set().y)}}function set_tool(a){switch(tool_action){case"pencil":canvas_context.strokeStyle=color_data,canvas_context.lineWidth=document.getElementById("brush").value,canvas_context.globalAlpha=1-document.getElementById("alpha").value,canvas_context.beginPath();break;case"eraser":canvas_context.strokeStyle="white",canvas_context.lineWidth=document.getElementById("clear").value,canvas_context.beginPath();break;case"hollow_circle":case"hollow_triangle":case"hollow_rectangle":canvas_context.strokeStyle=color_data,canvas_context.lineWidth=document.getElementById("hollow").value,canvas_context.globalAlpha=1-document.getElementById("alpha").value,canvas_x=doodle_box_set().x,canvas_y=doodle_box_set().y;break;case"solid_circle":case"solid_triangle":case"solid_rectangle":canvas_context.fillStyle=color_data,canvas_context.globalAlpha=1-document.getElementById("alpha").value,canvas_x=doodle_box_set().x,canvas_y=doodle_box_set().y}}